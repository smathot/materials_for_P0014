# Generated by OpenSesame 2.8.2 (Gutsy Gibson)
# Thu Jul 03 12:53:12 2014 (nt)
# <http://www.cogsci.nl/opensesame>

set mouse_backend "psycho"
set subject_parity "even"
set height "768"
set font_family "mono"
set font_italic "no"
set synth_backend "legacy"
set title "P0014.1 [Pupil size and working memory]"
set coordinates "relative"
set start "experiment"
set sampler_backend "legacy"
set transparent_variables "no"
set foreground "white"
set font_bold "no"
set description "A template containing a practice and an experimental phase"
set background "gray"
set font_size "18"
set keyboard_backend "psycho"
set canvas_backend "psycho"
set compensation "0"
set bidi "no"
set subject_nr "0"
set width "1024"

define feedback block_feedback
	set duration "keypress"
	set reset_variables "yes"
	set description "Provides feedback to the participant"
	draw textline 0 -96 "Einde blok [count_block_sequence] van [total_blocks] (0 = oefenfase)" center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 0 "Je accuratesse was [acc]%" center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 96 "Druk op een toets om door te gaan ..." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"

define loop block_loop
	set repeat "3"
	set description "A single block of trials"
	set item "trial_sequence"
	set break_if "never"
	set column_order "targetLum;probePosTarget;memCue"
	set cycles "8"
	set order "random"
	setcycle 0 targetLum "bright"
	setcycle 0 memCue "1"
	setcycle 0 probePosTarget "left"
	setcycle 1 targetLum "bright"
	setcycle 1 memCue "1"
	setcycle 1 probePosTarget "right"
	setcycle 2 targetLum "bright"
	setcycle 2 memCue "2"
	setcycle 2 probePosTarget "left"
	setcycle 3 targetLum "bright"
	setcycle 3 memCue "2"
	setcycle 3 probePosTarget "right"
	setcycle 4 targetLum "dark"
	setcycle 4 memCue "1"
	setcycle 4 probePosTarget "left"
	setcycle 5 targetLum "dark"
	setcycle 5 memCue "1"
	setcycle 5 probePosTarget "right"
	setcycle 6 targetLum "dark"
	setcycle 6 memCue "2"
	setcycle 6 probePosTarget "left"
	setcycle 7 targetLum "dark"
	setcycle 7 memCue "2"
	setcycle 7 probePosTarget "right"
	run trial_sequence

define sequence block_sequence
	set flush_keyboard "yes"
	set description "A sequence containing a single block of trials followed by feedback to the participant"
	run reset_feedback "always"
	run block_loop "always"
	run block_feedback "always"

define inline_script colorStim
	___run__
	def colorStimMask():
		
		"""
		Generates a mask of an empty circle.
		
		Returns:
		A 2D numpy array.
		"""
	
		r = colorStimSize/2-1
		m = colorStimThickness
		a = np.empty( (2*r+2, 2*r+2) )	
		a[:] = -1
		x, y = np.ogrid[-r:r+1,-r:r+1]
		i = x**2+y**2 <= r**2
		a[i] = 1	
		x, y = np.ogrid[-r+m:r-m+1,-r+m:r-m+1]
		i = (x-m)**2+(y-m)**2 <= (r-m*2)**2
		a[i] = -1
		a[-r-1:] = np.flipud(a[:r+1])
		a[:,-r-1:] = np.fliplr(a[:,:r+1])
		return a
		
	def colorStim(clrCls, variant=None, pos='center'):
		
		"""
		Generates a color stimulus.
		
		Arguments:
		clrCls		--	The color class, 'red', 'green', or 'blue'.
		
		Keyword arguments:
		variant		--	The color variant number or None for a pure color.
						(default=None)
		pos			--	The stimulus position, which should be 'center', 'up',
						'down', 'right', 'left', or a position tuple.
						(default='center')
		
		Returns:
		A GratingStim.
		"""
		
		assert(clrCls in ['red', 'green', 'blue'])
		assert(variant in range(nColor)+[None])
		assert(pos in ['center', 'up', 'down', 'right', 'left'] or \
			not isinstance(pos, str))
		if pos == 'center':
			xy = 0, 0
		elif pos == 'up':
			xy = 0, vEcc
		elif pos == 'down':
			xy = 0, -vEcc
		elif pos == 'left':
			xy = -hEcc, 0
		elif pos == 'right':
			xy = hEcc, 0
		else:
			xy = pos
		if variant == None:
			color = colorPure[clrCls]
		else:
			color = colorVar[clrCls][variant]
		return visual.GratingStim(win, size=colorStimSize, mask=colorStimMask(),
			tex=None, color=color, pos=xy)
			
	def showRefArrayStim(clrCls):
		
		"""
		Shows the reference array.
		
		Arguments:
		clrCls		--	The color class, 'red', 'green', or 'blue'.
		"""
		
		baseBgStim.draw()
		stableBgStim.setPos((0,0))
		stableBgStim.draw()
		for clrNr in range(nColor):
			dy = (clrNr+.5-nColor/2.) * colorStimSize * 1.2
			pos = 0, -dy
			colorStim(clrCls, variant=clrNr, pos=pos).draw()
			visual.ImageStim(win, exp.get_file('%d.png' % (clrNr+1)),
				pos=pos).draw()
		win.flip()
	__end__
	set _prepare ""
	set description "Functions for color-related stimuli"

define sketchpad debug_info
	set duration "keypress"
	set description "Displays stimuli"
	draw textline 0 -288 "Debug info" center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 0 "[debugInfo]" center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 -224 "(Enable/ disable in settings item)" center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 352 "Press any key to continue ..." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"

define sketchpad end_of_experiment
	set duration "keypress"
	set description "Displays stimuli"
	draw textline 0 -96 "Het experiment is afgelopen." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 0 "Bedankt voor je deelname." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 96 "Druk op een toets om af te sluiten ..." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"

define sketchpad end_of_practice
	set duration "keypress"
	set description "Displays stimuli"
	draw textline 0 96 "Druk op een toets om door te gaan ..." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 -96 "De oefenfase is afgelopen." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 0 "Het echte experiment begint nu." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"

define sequence experiment
	set flush_keyboard "yes"
	set description "The main sequence of the experiment"
	run imports "always"
	run settings "always"
	run stableBackground "always"
	run miscStim "always"
	run colorStim "always"
	run eyelink_calibrate "always"
	run instructions "always"
	run practice_loop "always"
	run end_of_practice "always"
	run experimental_loop "always"
	run end_of_experiment "always"

define loop experimental_loop
	set repeat "8"
	set description "A loop containing one or more experimental blocks"
	set item "block_sequence"
	set break_if "never"
	set column_order "practice"
	set cycles "1"
	set order "random"
	setcycle 0 practice "no"
	run block_sequence

define eyelink_calibrate eyelink_calibrate
	set sacc_vel_thresh "35"
	set cal_beep "yes"
	set description "Calibration/ initialization plugin for the Eyelink series of eye trackers (SR-Research)"
	set sacc_acc_thresh "9500"
	set cal_target_size "16"
	set force_drift_correct "yes"
	set tracker_attached "Yes"

define inline_script eyelink_drift_correct
	___run__
	stableSleep(preDriftDur, [fixDot], track=False)
	while not exp.eyelink.drift_correction(fix_triggered=True):
		exp.eyelink.calibrate()
		stableSleep(100, [fixDot], track=False)
	__end__
	set _prepare ""
	set description "Executes Python code"

define eyelink_log eyelink_log
	set msg ""
	set throttle "2"
	set description "Message log for the Eyelink series of eye trackers (SR-Research)"
	set auto_log "yes"

define eyelink_start_recording eyelink_start_recording
	set description "Start recording plugin for the Eyelink series of eye trackers (SR-Research)"
	set log_msg "start_trial [count_trial_sequence]"

define eyelink_stop_recording eyelink_stop_recording

define inline_script imports
	set _run ""
	___prepare__
	import numpy as np
	from psychopy import visual
	import random
	__end__
	set description "Import global modules"

define sketchpad instructions
	set duration "keypress"
	set description "Displays stimuli"
	draw textline 0 -96 "Heb je de instructies goed begrepen?" center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 96 "Druk op een toets om door te gaan ..." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"
	draw textline 0 0 "Zo ja, dan beginnen we met een korte oefenfase." center=1 color=white font_family="mono" font_size=18 font_italic=no font_bold=no show_if="always" html="yes"

define keyboard_response keyboard_response
	set allowed_responses "1;2;3"
	set description "Collects keyboard responses"
	set timeout "infinite"
	set flush "yes"

define logger logger
	set description "Logs experimental data"

define inline_script miscStim
	___run__
	def charStim(ch):
		
		"""
		Generates a character.
		
		Arguments:
		ch		--	The character.
		
		Returns:
		An ImageStim.
		"""
		
		return visual.ImageStim(win, exp.get_file('%s.png' % ch))
		
	def fixDotStim():
		
		"""
		Generates a fixation dot.
		
		Returns:
		An ImageStim.
		"""
		
		return visual.ImageStim(win, exp.get_file('cross.png'))
		
		
	def feedbackDotStim(correct):
		
		"""
		Generates a colored dot for immediate feedback.
		
		Arguments:
		correct		--	The correctness, 1 or 0.
		
		Returns:
		A GratingStim
		"""
		
		assert(correct in [0,1])
		if correct == 0:
			color = 'red'
		else:
			color = 'green'
		return visual.GratingStim(win, mask='circle', tex=None, color=color,
			size=feedbackDotSize)
	__end__
	set _prepare ""
	set description "Functions for various stimuli"

define loop practice_loop
	set repeat "1"
	set description "Repeatedly runs another item"
	set item "block_sequence"
	set break_if "never"
	set column_order "practice"
	set cycles "1"
	set order "random"
	setcycle 0 practice "yes"
	run block_sequence

define reset_feedback reset_feedback

define inline_script settings
	set _run ""
	___prepare__
	# Enable/ disable debug info
	exp.set('_debug', 'no')
	
	# Size and line thickness of the stimuli
	colorStimSize = 128
	colorStimThickness = 12
	# Size of feedback dots
	feedbackDotSize = 16
	# Horizontal and vertical eccentricity of stimuli
	w, h = exp.resolution()
	vEcc = 92
	hEcc = w/4
	total_blocks = 8
	# Various durations, see `trial_*` scripts
	preDriftDur = 995
	postDriftDur = 995
	memDur = 995
	postMemDur = 1495
	cueDur = 995
	blankDur = 4995
	feedbackDur = 495
	
	# The number of variants that are used on a given trial
	nColor = 3
	# Pure colors
	colorPure = {
		'green' : '#12C05C',
		'red' : '#ff816e',
		'blue' : '#71aaf9'
		}
	# Color variations
	colorVar = {
		'green' : [
			'#5c8600',
			'#6ea207',
			'#99dd77',
			'#00bb55',
			'#22942d',
			'#00dd99'
			],
		'red' : [
			'#ff6677',
			'#ff9999',
			'#fb1b26',
			'#df013a',
			'#fc437a',
			'#f97346'
			],
		'blue' : [
			'#00ddee',
			'#00bbff',
			'#0088ff',
			'#00eedd',
			'#00aabb',
			'#0088bb'
			]
		}
	
	# Set relevant variables so that they can be used in the GUI
	exp.set('total_blocks', total_blocks)
	__end__
	set description "Experimental settings"

define inline_script stableBackground
	set _run ""
	___prepare__
	def stableSleep(dur, stimList, track=True, phase=None):
		
		"""
		Sleeps for a prespecified duration, while the background is stabilized based
		on horizontal gaze position.
		
		Arguments:
		dur			--	The duration.
		stimList	--	A list of stimuli to present.
		
		Keyword arguments:
		track		--	Indicates whether gaze position should be tracked.
						(default=True)
		phase		--	Indicates the name of the trace phase. (default=None)
		"""
		
		start_time = self.time()
		i = 0
		while self.time() - start_time < dur:
			if track:
				x, y = exp.eyelink.sample()
				x -= w/2
				if abs(x) > w/6:
					x = 0
					exp.eyelink.log('stabilize error')
				else:				
					exp.eyelink.log('stabilize %f' % x)
			else:
				x, y = 0, 0		
			baseBgStim.draw()
			stableBgStim.setPos((x, 0))
			stableBgStim.draw()
			for stim in stimList:
				stim.draw()
			win.flip()
			if i == 0 and phase != None:
				exp.eyelink.log('phase %s' % phase)
			i += 1
		
	def initBackground(leftLum):
		
		"""
		Initializes the background stimuli.
		
		Arguments:
		leftLum	--	Indicates whether the left side is 'bright' or 'dark'
		"""
		
		global baseBgStim, stableBgStim
		assert(leftLum in ['bright', 'dark'])
		# Create background texture. The background texture is half bright and half
		# dark. The center gradient is implemented by the gradient texture.
		backgroundTex = np.empty( [1, w], dtype=float )
		backgroundTex[0,:w/2] = -1
		backgroundTex[0,w/2:] = 1
		if leftLum == 'dark':
			backgroundTex *= -1
		baseBgStim = visual.GratingStim(win, size=(w,h), tex=backgroundTex,
			mask=None)	
		# Create the gradient texture. This is 1/3 rd of the display width, and is
		# anchored to the point of gaze.
		gradientTex = np.empty( [1, w/3], dtype=float )
		gradientTex[0] = np.linspace(-1, 1, w/3)
		if leftLum == 'dark':
			gradientTex = gradientTex * -1
		stableBgStim = visual.GratingStim(win, size=(w/3,h), tex=gradientTex,
			mask=None)
	__end__
	set description "Functions for background rendering"

define inline_script trial_feedback
	___run__
	feedbackDot = feedbackDotStim(self.get('correct'))
	stableSleep(feedbackDur, [feedbackDot], track=False, phase='feedback')
	__end__
	set _prepare ""
	set description "Executes Python code"

define inline_script trial_prepare
	set _run ""
	___prepare__
	# Trial variables
	memCue = self.get('memCue')
	targetLum = self.get('targetLum')
	probePosTarget = self.get('probePosTarget')
	
	# Randomly select colors
	colorList = colorPure.keys()
	random.shuffle(colorList)
	clrClsTarget = colorList[0]
	random.shuffle(colorVar[clrClsTarget])
	clrNrTarget = random.randint(0, nColor-1)
	clrClsDist = colorList[1]
	random.shuffle(colorVar[clrClsDist])
	clrNrDist = random.randint(0, nColor-1)
	
	# Set debug info string. This is shown if _debug is set to 'yes' in the settings
	# item.
	debugInfo = ('Target = %s (%d +1 cr)<br />'
		'Choices = %s<br />'
		'Distractor = %s (%d)<br />'
		'memCue = %d') % (colorVar[clrClsTarget][clrNrTarget],
		clrNrTarget, colorVar[clrClsTarget][:nColor],
		colorVar[clrClsDist][clrNrDist], clrNrDist, memCue)
	exp.set('debugInfo', debugInfo)
	
	# Recode other variables that follow from trial variables
	if probePosTarget == 'left':
		probePosDist = 'right'
	else:
		probePosDist = 'left'
	
	if targetLum == 'bright':
		if probePosDist == 'left':
			leftLum = 'bright'
		else:
			leftLum = 'dark'
	else:
		if probePosDist == 'left':
			leftLum = 'dark'
		else:
			leftLum = 'bright'
			
	# Assert for correctness
	assert(probePosTarget in ['left', 'right'])
	assert(probePosDist in ['left', 'right'])
	assert(memCue in [1, 2])
	assert(targetLum in ['bright', 'dark'])
	assert(leftLum in ['bright', 'dark'])
	assert(clrClsTarget in colorList)
	assert(clrClsDist in colorList)
	assert(clrNrTarget in range(nColor))
	assert(clrNrDist in range(nColor))
	
	# Initialize stimuli
	cue = charStim(memCue)
	fixDot = fixDotStim()
	memStimTarget = colorStim(clrClsTarget, variant=clrNrTarget)
	memStimDist = colorStim(clrClsDist, variant=clrNrDist)
	probeStimTarget = colorStim(clrClsTarget, pos=probePosTarget)
	probeStimDist = colorStim(clrClsDist, pos=probePosDist)
	initBackground(leftLum)
	
	# Set experimental variables that have been determined online
	exp.set('clrClsTarget', clrClsTarget)
	exp.set('clrNrTarget', clrNrTarget)
	exp.set('clrClsDist', clrClsDist)
	exp.set('clrNrDist', clrNrDist)
	exp.set('probePostDist', probePosDist)
	exp.set('leftLum', leftLum)
	exp.set('correct_response', clrNrTarget+1)
	__end__
	set description "Executes Python code"

define inline_script trial_run
	___run__
	stableSleep(postDriftDur, [fixDot], track=False)
	
	if memCue == 1:
		stableSleep(memDur, [fixDot, memStimTarget], phase='targetStim1')
		stableSleep(postMemDur, [fixDot], phase='postTargetStim1')
		stableSleep(memDur, [fixDot, memStimDist], phase='distStim1')
		stableSleep(postMemDur, [fixDot], phase='postDistStim1')
	else:
		stableSleep(memDur, [fixDot, memStimDist], phase='distStim1')
		stableSleep(postMemDur, [fixDot], phase='postDistStim1')
		stableSleep(memDur, [fixDot, memStimTarget], phase='targetStim1')
		stableSleep(postMemDur, [fixDot], phase='postTargetStim1')	
	stableSleep(cueDur, [cue], phase='cue')
	stableSleep(blankDur, [fixDot, probeStimDist, probeStimTarget],
		phase='retention')
	showRefArrayStim(clrClsTarget)
	exp.eyelink.log('phase memoryProbe')
	__end__
	set _prepare ""
	set description "Executes Python code"

define sequence trial_sequence
	set flush_keyboard "yes"
	set description "A single trial"
	run trial_prepare "always"
	run debug_info "[_debug] = yes"
	run eyelink_drift_correct "always"
	run eyelink_start_recording "always"
	run trial_run "always"
	run keyboard_response "always"
	run trial_feedback "always"
	run logger "always"
	run eyelink_log "always"
	run eyelink_stop_recording "always"

